---
import BasePage from "../../layouts/BasePage.astro"
import Content from "../../layouts/Content.astro";
---
<BasePage title="SortableList">
	<Content header="Ranking List">
		<form id="addForm">
			<label for="entry">Add an item:</label>
			<input type="text" placeholder="new entry" id="newItem">
			<button id="addButton">add</button>
		</form>
		<ol id="sortList" class="moveable"></ol>
		<div><button id="downloadButton" >Download List</button></div>
	</Content>
</BasePage>
<style>
[draggable="true"] {
  user-select: none;
  -moz-user-select: none;
  -webkit-user-select: none;
  -ms-user-select: none;
}
ol.moveable {
  margin: 0px;
  margin-bottom: 5px;
  padding-left: 20px;
  list-style-type: decimal;
  padding-bottom: 20px;
  border-bottom: 1px solid grey;
}
li {
    margin: 10px;
    padding: 4px;
    border-radius: 4px;
    color: #666;
    cursor: move;
    cursor: grab;
    border: 1px solid grey;
}
li:active: {
    cursor: grabbing;
}
li:hover {
    background-color: #eee;
}
button {
    border: 1px solid white;
    padding: 1px 4px;

}
</style>
<script>
const button = document.getElementById("addButton") as HTMLButtonElement
const input =  document.getElementById("newItem") as HTMLInputElement
const form = document.getElementById("addForm") as HTMLFormElement
const list = document.getElementById("sortList") as HTMLOListElement
const downloadButton = document.getElementById("downloadButton") as HTMLButtonElement
const downloadList = (e) => {
	const content = Array.from(list.children).map((ele, idx) => `${idx+1}. ${ele.textContent}`).join("\n")
	const element = document.createElement("a")
	element.setAttribute("href", "data:text/plain;charset=utf-8,"+encodeURIComponent(content))
	element.setAttribute("download", "ranking.txt")
	element.style.display = "none"
	document.body.append(element)
	element.click()
	document.body.removeChild(element)

}
downloadButton.addEventListener("click", downloadList)

form?.addEventListener("submit", e => {
    	e.preventDefault()
})
const getIndex = e => {
	const element = e.target.closest("li")
	return Array.from(list.children).indexOf(element)
}
const dragStart = (e) => {
	e.dataTransfer.setData("text/plain", getIndex(e))
}
const drop = (e) => {
	cancelDefault(e)
	const oldIndex = e.dataTransfer.getData("text/plain")
	const newIndex = Array.from(list.children).indexOf(e.target)
	const node = list.children[oldIndex]
	list.removeChild(list.children[oldIndex])
	list.insertBefore(node, list.children[newIndex])
}
const cancelDefault = (e) => {
	e.preventDefault()
	e.stopPropagation()
	return false
}
button?.addEventListener("click", () => {
	if (input.value.length === 0 ) return
    	const li = document.createElement("li")
    	li.appendChild(document.createTextNode(input.value))
    	li.setAttribute("draggable", "true")
    	li.addEventListener("dragstart", dragStart)
    	li.addEventListener("drop", drop)
    	li.addEventListener("dragenter", cancelDefault)
    	li.addEventListener("dragover", cancelDefault)
    	list.appendChild(li)
    	input.value = ""
})
    
</script>
